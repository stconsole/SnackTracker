<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snack Tracker Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --secondary: #FF9800;
            --accent: #2196F3;
            --text: #333333;
            --text-light: #757575;
            --border: #E0E0E0;
            --error: #F44336;
            --success: #4CAF50;
            --background: #FAFAFA;
            --card-bg: #FFFFFF;
            --table-header: #F5F5F5;
            --table-hover: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] {
            --primary: #66BB6A;
            --primary-dark: #81C784;
            --secondary: #FFA726;
            --accent: #42A5F5;
            --text: #E0E0E0;
            --text-light: #B0B0B0;
            --border: #424242;
            --background: #121212;
            --card-bg: #1E1E1E;
            --table-header: #2D2D2D;
            --table-hover: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            gap: 20px;
        }

        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--text);
        }

        h1 {
            font-size: 28px;
            color: var(--primary);
        }

        h2 {
            font-size: 22px;
            margin-bottom: 15px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Open Sans', sans-serif;
            font-size: 15px;
            background-color: var(--card-bg);
            color: var(--text);
            text-transform: capitalize;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        button.danger {
            background-color: var(--error);
        }

        button.danger:hover {
            background-color: #D32F2F;
        }

        button.secondary {
            background-color: var(--secondary);
        }

        button.secondary:hover {
            background-color: #F57C00;
        }

        .theme-toggle {
            background-color: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: var(--table-header);
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: var(--table-hover);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-low {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--secondary);
        }

        .status-critical {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error);
        }

        .status-good {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background-color: var(--success);
        }

        .toast.error {
            background-color: var(--error);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .inventory-health {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .health-metric {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            background-color: var(--card-bg);
        }

        .health-metric h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--text-light);
        }

        .health-metric p {
            font-size: 24px;
            font-weight: 700;
        }

        .health-metric.critical {
            border-left: 4px solid var(--error);
        }

        .health-metric.warning {
            border-left: 4px solid var(--secondary);
        }

        .health-metric.good {
            border-left: 4px solid var(--primary);
        }

        .inventory-list {
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
            font-size: 14px;
        }

        .inventory-list div {
            padding: 4px 0;
            border-bottom: 1px dashed var(--border);
        }

        .category-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .category-chips {
            background-color: rgba(255, 152, 0, 0.1);
            color: #FF9800;
        }

        .category-candy {
            background-color: rgba(156, 39, 176, 0.1);
            color: #9C27B0;
        }

        .category-drinks {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }

        /* Dashboard Styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .dashboard-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card h3 {
            margin-bottom: 10px;
            color: var(--primary);
            font-style: normal;
        }
        
        .dashboard-card i {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
            font-style: normal;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .item-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .item-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .item-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .back-btn {
            background-color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .inventory-health {
                flex-direction: column;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçø Snack Tracker Pro</h1>
            <div>
                <button onclick="clearHistory()" class="danger" style="margin-right: 10px;">
                    üóëÔ∏è Clear Data
                </button>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="theme-icon">üåô</span> Theme
                </button>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="dashboard">
                <div class="dashboard-card" onclick="showSection('add-purchase')">
                    <i>‚ûï</i>
                    <h3>Add Purchase</h3>
                    <p>Record new inventory</p>
                </div>
                <div class="dashboard-card" onclick="showSection('record-sale')">
                    <i>üí∞</i>
                    <h3>Record Sale</h3>
                    <p>Log customer transactions</p>
                </div>
                <div class="dashboard-card" onclick="showSection('item-performance')">
                    <i>üìä</i>
                    <h3>Item Performance</h3>
                    <p>View individual item analytics</p>
                </div>
                <div class="dashboard-card" onclick="showSection('overall-performance')">
                    <i>üìà</i>
                    <h3>Overall Performance</h3>
                    <p>See category comparisons</p>
                </div>
            </div>
        </div>

        <!-- Add Purchase Section -->
        <div id="add-purchase" class="section">
            <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back to Dashboard</button>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <h2>‚ûï Add Purchase</h2>
                    </div>
                </div>
                <div class="form-group">
                    <label for="itemName">Item Name</label>
                    <input type="text" id="itemName" placeholder="e.g., Doritos" required>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" required>
                        <option value="chips">Chips</option>
                        <option value="candy">Candy</option>
                        <option value="drinks">Drinks</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="buyPrice">Buy Price ($)</label>
                    <input type="number" id="buyPrice" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="quantityBought">Quantity</label>
                    <input type="number" id="quantityBought" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="restockThreshold">Restock Alert At</label>
                    <input type="number" id="restockThreshold" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="discount">Discount</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="discount" step="0.01" min="0" style="flex: 2;">
                        <select id="discountType" style="flex: 1;">
                            <option value="fixed">$ Fixed</option>
                            <option value="percent">% Percent</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="datePurchased">Date Purchased</label>
                    <input type="date" id="datePurchased" required>
                </div>
                <button onclick="addPurchase()" style="width: 100%;">
                    üì¶ Add Inventory
                </button>
            </div>
        </div>

        <!-- Record Sale Section -->
        <div id="record-sale" class="section">
            <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back to Dashboard</button>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <h2>üí∞ Record Sale</h2>
                    </div>
                </div>
                <div class="form-group">
                    <label for="soldItem">Item</label>
                    <select id="soldItem" required>
                        <option value="">Select Item</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sellPrice">Sell Price ($)</label>
                    <input type="number" id="sellPrice" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="quantitySold">Quantity</label>
                    <input type="number" id="quantitySold" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="customer">Customer</label>
                    <input type="text" id="customer" placeholder="e.g., Customer #101">
                </div>
                <div class="form-group">
                    <label for="dateSold">Date Sold</label>
                    <input type="date" id="dateSold" required>
                </div>
                <button onclick="recordSale()" style="width: 100%;" class="secondary">
                    üí∏ Record Sale
                </button>
            </div>
        </div>

        <!-- Item Performance Section -->
        <div id="item-performance" class="section">
            <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back to Dashboard</button>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <h2>üìä Item Performance</h2>
                    </div>
                </div>
                <div class="item-performance-grid" id="itemButtons">
                    <!-- Dynamically filled with item buttons -->
                </div>
                <div id="item-analytics-container">
                    <!-- Item analytics will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Overall Performance Section -->
        <div id="overall-performance" class="section">
            <button class="back-btn" onclick="showSection('dashboard')">‚Üê Back to Dashboard</button>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <h2>üìà Overall Performance</h2>
                    </div>
                </div>
                <div class="analytics-grid">
                    <div class="chart-container">
                        <canvas id="categoryProfitChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryVolumeChart"></canvas>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">
                            <h2>Category Comparison</h2>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryComparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Health Section -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <h2>üìä Inventory Health</h2>
                </div>
            </div>
            <div class="inventory-health">
                <div class="health-metric critical" id="criticalItems">
                    <h3>Critical (Sold Out)</h3>
                    <p>0 items</p>
                    <div class="inventory-list" id="criticalList"></div>
                </div>
                <div class="health-metric warning" id="lowItems">
                    <h3>Low Stock (1 left)</h3>
                    <p>0 items</p>
                    <div class="inventory-list" id="lowList"></div>
                </div>
                <div class="health-metric good" id="healthyItems">
                    <h3>In Stock (2+)</h3>
                    <p>0 items</p>
                    <div class="inventory-list" id="healthyList"></div>
                </div>
            </div>
        </div>

        <!-- Transaction Table Section -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <h2>üìù Transaction History</h2>
                </div>
                <div>
                    <label for="categoryFilter">Filter by Category:</label>
                    <select id="categoryFilter" onchange="renderTable()">
                        <option value="all">All Categories</option>
                        <option value="chips">Chips</option>
                        <option value="candy">Candy</option>
                        <option value="drinks">Drinks</option>
                    </select>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Category</th>
                        <th>Buy Price</th>
                        <th>Qty Bought</th>
                        <th>Remaining</th>
                        <th>Date Purchased</th>
                        <th>Final Cost</th>
                        <th>Sell Price</th>
                        <th>Qty Sold</th>
                        <th>Date Sold</th>
                        <th>Profit</th>
                        <th>Customer</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Transactions will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Constants
        const CATEGORIES = {
            CHIPS: 'chips',
            CANDY: 'candy',
            DRINKS: 'drinks'
        };

        // Global variables
        let inventory = JSON.parse(localStorage.getItem('snackInventory')) || [];
        let profitChart = null;
        let cashFlowChart = null;
        let categoryChart = null;
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Dashboard chart variables
        let categoryProfitChart = null;
        let categoryVolumeChart = null;
        let categoryComparisonChart = null;
        let itemPerformanceChart = null;

        // Initialize theme
        function initTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-icon').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Toggle between dark/light mode
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-icon').textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', currentTheme);
            updateChartsTheme();
        }

        // Update charts to match current theme
        function updateChartsTheme() {
            const textColor = currentTheme === 'dark' ? '#E0E0E0' : '#333333';
            const gridColor = currentTheme === 'dark' ? '#424242' : '#E0E0E0';
            
            if (profitChart) {
                profitChart.options.scales.x.ticks.color = textColor;
                profitChart.options.scales.y.ticks.color = textColor;
                profitChart.options.scales.x.grid.color = gridColor;
                profitChart.options.scales.y.grid.color = gridColor;
                profitChart.update();
            }
            
            if (cashFlowChart) {
                cashFlowChart.options.scales.x.ticks.color = textColor;
                cashFlowChart.options.scales.y.ticks.color = textColor;
                cashFlowChart.options.scales.x.grid.color = gridColor;
                cashFlowChart.options.scales.y.grid.color = gridColor;
                cashFlowChart.update();
            }
            
            if (categoryChart) {
                categoryChart.options.scales.x.ticks.color = textColor;
                categoryChart.options.scales.y.ticks.color = textColor;
                categoryChart.options.scales.x.grid.color = gridColor;
                categoryChart.options.scales.y.grid.color = gridColor;
                categoryChart.update();
            }
            
            if (categoryProfitChart) {
                categoryProfitChart.options.scales.x.ticks.color = textColor;
                categoryProfitChart.options.scales.y.ticks.color = textColor;
                categoryProfitChart.options.scales.x.grid.color = gridColor;
                categoryProfitChart.options.scales.y.grid.color = gridColor;
                categoryProfitChart.update();
            }
            
            if (categoryVolumeChart) {
                categoryVolumeChart.options.scales.x.ticks.color = textColor;
                categoryVolumeChart.options.scales.y.ticks.color = textColor;
                categoryVolumeChart.options.scales.x.grid.color = gridColor;
                categoryVolumeChart.options.scales.y.grid.color = gridColor;
                categoryVolumeChart.update();
            }
            
            if (categoryComparisonChart) {
                categoryComparisonChart.options.scales.r.ticks.color = textColor;
                categoryComparisonChart.update();
            }
            
            if (itemPerformanceChart) {
                itemPerformanceChart.options.scales.x.ticks.color = textColor;
                itemPerformanceChart.options.scales.y.ticks.color = textColor;
                itemPerformanceChart.options.scales.y1.ticks.color = textColor;
                itemPerformanceChart.options.scales.x.grid.color = gridColor;
                itemPerformanceChart.options.scales.y.grid.color = gridColor;
                itemPerformanceChart.update();
            }
        }

        // Auto-capitalize first letter of inputs
        document.addEventListener('input', function(e) {
            if (e.target.id === 'itemName' || e.target.id === 'customer') {
                if (e.target.value.length === 1) {
                    e.target.value = e.target.value.charAt(0).toUpperCase();
                }
            }
        });

        // Utility functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function saveData() {
            localStorage.setItem('snackInventory', JSON.stringify(inventory));
        }

        function validateForm(fields) {
            for (const [fieldName, element] of Object.entries(fields)) {
                if (!element.value || element.value.toString().trim() === '') {
                    showToast(`Please fill in the ${fieldName} field`, 'error');
                    element.focus();
                    return false;
                }
                
                if (element.type === 'number' && parseFloat(element.value) <= 0) {
                    showToast(`${fieldName} must be greater than 0`, 'error');
                    element.focus();
                    return false;
                }
            }
            return true;
        }

        // Calculate available inventory
        function getAvailableInventory() {
            const available = {};
            
            // First pass: Sum all purchases
            inventory.forEach(item => {
                if (item.isPurchase) {
                    const key = item.itemName.toLowerCase();
                    available[key] = (available[key] || 0) + item.quantityBought;
                }
            });
            
            // Second pass: Subtract all sales
            inventory.forEach(item => {
                if (!item.isPurchase) {
                    const key = item.itemName.toLowerCase();
                    if (available[key] !== undefined) {
                        available[key] -= item.quantitySold;
                    }
                }
            });
            
            return available;
        }

        function updateInventoryHealth() {
            const available = getAvailableInventory();
            const purchaseItems = inventory.filter(item => item.isPurchase);
            
            let critical = [];
            let low = [];
            let healthy = [];
            
            // Categorize items
            purchaseItems.forEach(item => {
                const key = item.itemName.toLowerCase();
                const qty = available[key] || 0;
                
                if (qty <= 0) {
                    critical.push(item.itemName);
                } else if (qty === 1) {
                    low.push(item.itemName);
                } else {
                    healthy.push(item.itemName);
                }
            });
            
            // Update counts
            document.getElementById('criticalItems').querySelector('p').textContent = `${critical.length} items`;
            document.getElementById('lowItems').querySelector('p').textContent = `${low.length} items`;
            document.getElementById('healthyItems').querySelector('p').textContent = `${healthy.length} items`;
            
            // Update lists
            document.getElementById('criticalList').innerHTML = critical.map(item => `<div>${item}</div>`).join('');
            document.getElementById('lowList').innerHTML = low.map(item => `<div>${item}</div>`).join('');
            document.getElementById('healthyList').innerHTML = healthy.map(item => `<div>${item}</div>`).join('');
        }

        function updateDropdown() {
            const dropdown = document.getElementById('soldItem');
            dropdown.innerHTML = '<option value="">Select Item</option>';
            
            const available = getAvailableInventory();
            const purchaseItems = inventory.filter(item => item.isPurchase);
            
            // Group available items by name
            const itemGroups = {};
            
            purchaseItems.forEach((item, index) => {
                const key = item.itemName.toLowerCase();
                const availableQty = available[key] || 0;
                
                if (availableQty > 0) {
                    if (!itemGroups[key]) {
                        itemGroups[key] = {
                            name: item.itemName,
                            indices: [],
                            available: availableQty,
                            cost: item.finalCost
                        };
                    }
                    itemGroups[key].indices.push(index);
                }
            });
            
            // Add available items to dropdown
            for (const group of Object.values(itemGroups)) {
                const option = document.createElement('option');
                option.value = group.indices.join(',');
                option.textContent = `${group.name} (${group.available} left, Cost: ${formatCurrency(group.cost)})`;
                
                // Highlight low stock
                if (group.available === 1) {
                    option.style.color = '#FF9800';
                }
                
                dropdown.appendChild(option);
            }
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            const categoryFilter = document.getElementById('categoryFilter').value;
            const available = getAvailableInventory();
            
            // Show all transactions
            inventory.forEach((item, index) => {
                // Skip if doesn't match category filter
                if (categoryFilter !== 'all' && item.category !== categoryFilter) return;
                
                const remaining = available[item.itemName.toLowerCase()] || 0;
                const row = document.createElement('tr');
                
                // Determine stock status
                let status = '';
                if (remaining <= 0) {
                    status = '<span class="status-badge status-critical">Sold Out</span>';
                } else if (remaining === 1) {
                    status = '<span class="status-badge status-low">Low Stock</span>';
                } else {
                    status = '<span class="status-badge status-good">In Stock</span>';
                }
                
                row.innerHTML = `
                    <td>${item.itemName}</td>
                    <td><span class="category-tag category-${item.category}">${item.category}</span></td>
                    <td>${formatCurrency(item.buyPrice)}</td>
                    <td>${item.quantityBought}</td>
                    <td>${item.isPurchase ? remaining : '-'} ${item.isPurchase ? status : ''}</td>
                    <td>${item.isPurchase ? formatDate(item.datePurchased) : '-'}</td>
                    <td>${formatCurrency(item.finalCost)}</td>
                    <td>${!item.isPurchase ? formatCurrency(item.sellPrice) : '-'}</td>
                    <td>${!item.isPurchase ? item.quantitySold : '-'}</td>
                    <td>${!item.isPurchase ? formatDate(item.dateSold) : '-'}</td>
                    <td>${!item.isPurchase ? formatCurrency(item.profit) : '-'}</td>
                    <td>${!item.isPurchase ? item.customer : '-'}</td>
                `;
                tableBody.appendChild(row);
            });
            
            updateInventoryHealth();
        }

        // Dashboard navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Load specific content when sections are shown
            if (sectionId === 'item-performance') {
                updateItemButtons();
            } else if (sectionId === 'overall-performance') {
                updateOverallPerformanceCharts();
            }
            
            // Reset forms when showing add-purchase or record-sale sections
            if (sectionId === 'add-purchase' || sectionId === 'record-sale') {
                resetForms();
            }
        }

        // Reset all form fields
        function resetForms() {
            document.getElementById('itemName').value = '';
            document.getElementById('buyPrice').value = '';
            document.getElementById('quantityBought').value = '1';
            document.getElementById('restockThreshold').value = '1';
            document.getElementById('discount').value = '';
            document.getElementById('datePurchased').valueAsDate = new Date();
            
            document.getElementById('sellPrice').value = '';
            document.getElementById('quantitySold').value = '1';
            document.getElementById('customer').value = '';
            document.getElementById('dateSold').valueAsDate = new Date();
            
            // Update dropdown for record sale form
            updateDropdown();
        }

        // Update item buttons for performance analysis
        function updateItemButtons() {
            const container = document.getElementById('itemButtons');
            container.innerHTML = '';
            
            // Get unique items
            const items = {};
            inventory.forEach(item => {
                if (item.isPurchase) {
                    items[item.itemName] = true;
                }
            });
            
            // Create buttons for each item
            Object.keys(items).forEach(itemName => {
                const button = document.createElement('div');
                button.className = 'item-btn';
                button.textContent = itemName;
                button.onclick = () => showItemAnalytics(itemName);
                container.appendChild(button);
            });
        }

        // Show analytics for specific item
        function showItemAnalytics(itemName) {
            const container = document.getElementById('item-analytics-container');
            container.innerHTML = '';
            
            // Filter relevant records
            const purchases = inventory.filter(item => 
                item.isPurchase && item.itemName === itemName
            );
            const sales = inventory.filter(item => 
                !item.isPurchase && item.itemName === itemName
            );
            
            // Calculate stats
            const totalPurchased = purchases.reduce((sum, item) => sum + item.quantityBought, 0);
            const totalSold = sales.reduce((sum, item) => sum + item.quantitySold, 0);
            const totalProfit = sales.reduce((sum, item) => sum + item.profit, 0);
            const avgProfit = sales.length > 0 ? totalProfit / sales.length : 0;
            const avgSellPrice = sales.length > 0 ? 
                sales.reduce((sum, item) => sum + item.sellPrice, 0) / sales.length : 0;
            
            // Create stats display
            const statsHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <h2>${itemName} Performance</h2>
                        </div>
                    </div>
                    <div class="grid" style="margin-bottom: 20px;">
                        <div class="card">
                            <h3>Total Purchased</h3>
                            <p style="font-size: 24px; font-weight: bold;">${totalPurchased}</p>
                        </div>
                        <div class="card">
                            <h3>Total Sold</h3>
                            <p style="font-size: 24px; font-weight: bold;">${totalSold}</p>
                        </div>
                        <div class="card">
                            <h3>Total Profit</h3>
                            <p style="font-size: 24px; font-weight: bold;">${formatCurrency(totalProfit)}</p>
                        </div>
                        <div class="card">
                            <h3>Avg Profit</h3>
                            <p style="font-size: 24px; font-weight: bold;">${formatCurrency(avgProfit)}</p>
                        </div>
                        <div class="card">
                            <h3>Avg Sell Price</h3>
                            <p style="font-size: 24px; font-weight: bold;">${formatCurrency(avgSellPrice)}</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="itemPerformanceChart"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = statsHTML;
            
            // Create chart
            createItemPerformanceChart(itemName, purchases, sales);
        }

        function createItemPerformanceChart(itemName, purchases, sales) {
            const ctx = document.getElementById('itemPerformanceChart').getContext('2d');
            
            if (itemPerformanceChart) {
                itemPerformanceChart.destroy();
            }
            
            // Prepare data for chart
            const labels = [];
            const purchaseData = [];
            const saleData = [];
            const profitData = [];
            
            // Group by month
            const monthlyData = {};
            
            purchases.forEach(purchase => {
                const date = new Date(purchase.datePurchased);
                const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        purchases: 0,
                        sales: 0,
                        profit: 0
                    };
                }
                monthlyData[monthYear].purchases += purchase.quantityBought;
            });
            
            sales.forEach(sale => {
                const date = new Date(sale.dateSold);
                const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        purchases: 0,
                        sales: 0,
                        profit: 0
                    };
                }
                monthlyData[monthYear].sales += sale.quantitySold;
                monthlyData[monthYear].profit += sale.profit;
            });
            
            // Sort by date
            const sortedMonths = Object.keys(monthlyData).sort();
            
            sortedMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                labels.push(monthName);
                purchaseData.push(monthlyData[month].purchases);
                saleData.push(monthlyData[month].sales);
                profitData.push(monthlyData[month].profit);
            });
            
            itemPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Purchased',
                            data: purchaseData,
                            backgroundColor: '#2196F3',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Sold',
                            data: saleData,
                            backgroundColor: '#4CAF50',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Profit',
                            data: profitData,
                            backgroundColor: '#FF9800',
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${itemName} Performance Over Time`,
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.label === 'Profit') {
                                        label += formatCurrency(context.raw);
                                    } else {
                                        label += context.raw;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Profit ($)'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateOverallPerformanceCharts() {
            updateCategoryProfitChart();
            updateCategoryVolumeChart();
            updateCategoryComparisonChart();
        }

        function updateCategoryProfitChart() {
            const ctx = document.getElementById('categoryProfitChart').getContext('2d');
            
            if (categoryProfitChart) {
                categoryProfitChart.destroy();
            }
            
            // Calculate category profits
            const categoryProfits = {
                chips: 0,
                candy: 0,
                drinks: 0
            };
            
            inventory.forEach(item => {
                if (!item.isPurchase) {
                    categoryProfits[item.category] += item.profit;
                }
            });
            
            categoryProfitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Chips', 'Candy', 'Drinks'],
                    datasets: [{
                        label: 'Total Profit',
                        data: [
                            categoryProfits.chips,
                            categoryProfits.candy,
                            categoryProfits.drinks
                        ],
                        backgroundColor: [
                            '#FF9800',
                            '#9C27B0',
                            '#2196F3'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total Profit by Category',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Profit: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCategoryVolumeChart() {
            const ctx = document.getElementById('categoryVolumeChart').getContext('2d');
            
            if (categoryVolumeChart) {
                categoryVolumeChart.destroy();
            }
            
            // Calculate category volumes
            const categoryVolumes = {
                chips: { purchased: 0, sold: 0 },
                candy: { purchased: 0, sold: 0 },
                drinks: { purchased: 0, sold: 0 }
            };
            
            inventory.forEach(item => {
                if (item.isPurchase) {
                    categoryVolumes[item.category].purchased += item.quantityBought;
                } else {
                    categoryVolumes[item.category].sold += item.quantitySold;
                }
            });
            
            categoryVolumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Chips', 'Candy', 'Drinks'],
                    datasets: [
                        {
                            label: 'Purchased',
                            data: [
                                categoryVolumes.chips.purchased,
                                categoryVolumes.candy.purchased,
                                categoryVolumes.drinks.purchased
                            ],
                            backgroundColor: '#2196F3'
                        },
                        {
                            label: 'Sold',
                            data: [
                                categoryVolumes.chips.sold,
                                categoryVolumes.candy.sold,
                                categoryVolumes.drinks.sold
                            ],
                            backgroundColor: '#4CAF50'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Purchase/Sale Volume by Category',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }

        function updateCategoryComparisonChart() {
            const ctx = document.getElementById('categoryComparisonChart').getContext('2d');
            
            if (categoryComparisonChart) {
                categoryComparisonChart.destroy();
            }
            
            // Calculate category metrics
            const categoryData = {
                chips: { profit: 0, items: 0, sales: 0 },
                candy: { profit: 0, items: 0, sales: 0 },
                drinks: { profit: 0, items: 0, sales: 0 }
            };
            
            inventory.forEach(item => {
                if (!item.isPurchase) {
                    categoryData[item.category].profit += item.profit;
                    categoryData[item.category].sales += item.quantitySold;
                    categoryData[item.category].items++;
                }
            });
            
            // Calculate averages
            const labels = ['Chips', 'Candy', 'Drinks'];
            const avgProfit = labels.map(cat => {
                const data = categoryData[cat.toLowerCase()];
                return data.items > 0 ? data.profit / data.items : 0;
            });
            
            const avgSalePrice = labels.map(cat => {
                const data = categoryData[cat.toLowerCase()];
                return data.sales > 0 ? data.profit / data.sales : 0;
            });
            
            categoryComparisonChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Total Profit', 'Avg Profit per Item', 'Avg Profit per Sale'],
                    datasets: [
                        {
                            label: 'Chips',
                            data: [
                                categoryData.chips.profit,
                                avgProfit[0],
                                avgSalePrice[0]
                            ],
                            backgroundColor: 'rgba(255, 152, 0, 0.2)',
                            borderColor: '#FF9800',
                            pointBackgroundColor: '#FF9800'
                        },
                        {
                            label: 'Candy',
                            data: [
                                categoryData.candy.profit,
                                avgProfit[1],
                                avgSalePrice[1]
                            ],
                            backgroundColor: 'rgba(156, 39, 176, 0.2)',
                            borderColor: '#9C27B0',
                            pointBackgroundColor: '#9C27B0'
                        },
                        {
                            label: 'Drinks',
                            data: [
                                categoryData.drinks.profit,
                                avgProfit[2],
                                avgSalePrice[2]
                            ],
                            backgroundColor: 'rgba(33, 150, 243, 0.2)',
                            borderColor: '#2196F3',
                            pointBackgroundColor: '#2196F3'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Category Performance Comparison',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function clearHistory() {
            if (confirm("‚ö†Ô∏è Delete ALL history? This cannot be undone!")) {
                inventory = [];
                localStorage.removeItem('snackInventory');
                resetForms();
                updateDropdown();
                renderTable();
                updateProfitChart();
                updateCashFlowProjection();
                updateCategoryAnalytics();
                showToast('All data has been cleared', 'success');
            }
        }

        function addPurchase() {
            const fields = {
                'item name': document.getElementById('itemName'),
                'buy price': document.getElementById('buyPrice'),
                'quantity': document.getElementById('quantityBought'),
                'date purchased': document.getElementById('datePurchased')
            };

            if (!validateForm(fields)) return;

            const itemName = fields['item name'].value;
            const category = document.getElementById('category').value;
            const buyPrice = parseFloat(fields['buy price'].value);
            const quantityBought = parseInt(fields['quantity'].value) || 1;
            const restockThreshold = parseInt(document.getElementById('restockThreshold').value) || 1;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const discountType = document.getElementById('discountType').value;
            const datePurchased = fields['date purchased'].value || new Date().toISOString().split('T')[0];

            // Validate final cost
            let finalCost;
            if (discountType === 'percent') {
                finalCost = buyPrice * (1 - discount / 100);
            } else {
                finalCost = buyPrice - discount;
            }

            if (finalCost <= 0) {
                showToast("Final cost cannot be negative", "error");
                return;
            }

            inventory.push({
                itemName: itemName.charAt(0).toUpperCase() + itemName.slice(1),
                category,
                buyPrice,
                quantityBought,
                restockThreshold,
                datePurchased,
                discount: `${discount}${discountType === 'percent' ? '%' : '$'}`,
                finalCost,
                sellPrice: null,
                quantitySold: 0,
                dateSold: null,
                profit: null,
                customer: null,
                isPurchase: true
            });

            saveData();
            updateDropdown();
            renderTable();
            updateProfitChart();
            updateCashFlowProjection();
            updateCategoryAnalytics();
            showToast('Purchase added successfully!');
            
            // Reset the form after successful submission
            resetForms();
        }

        function recordSale() {
            const fields = {
                'item': document.getElementById('soldItem'),
                'sell price': document.getElementById('sellPrice'),
                'quantity': document.getElementById('quantitySold'),
                'date sold': document.getElementById('dateSold')
            };

            if (!validateForm(fields)) return;

            const selectedIndices = fields['item'].value.split(',');
            const sellPrice = parseFloat(fields['sell price'].value);
            const quantitySold = parseInt(fields['quantity'].value) || 1;
            const customer = document.getElementById('customer').value;
            const dateSold = fields['date sold'].value || new Date().toISOString().split('T')[0];

            // Get the original purchase record
            const purchaseItem = inventory[selectedIndices[0]];
            
            // Calculate profit per unit (sellPrice - cost per unit)
            const profitPerUnit = sellPrice - purchaseItem.finalCost;
            const totalProfit = profitPerUnit * quantitySold;
            
            // Create a sale record
            const saleRecord = {
                itemName: purchaseItem.itemName,
                category: purchaseItem.category,
                buyPrice: purchaseItem.buyPrice,
                quantityBought: quantitySold,
                finalCost: purchaseItem.finalCost,
                sellPrice: sellPrice,
                quantitySold: quantitySold,
                dateSold: dateSold,
                profit: totalProfit,
                customer: customer.charAt(0).toUpperCase() + customer.slice(1),
                isPurchase: false
            };

            inventory.push(saleRecord);

            saveData();
            updateDropdown();
            renderTable();
            updateProfitChart();
            updateCashFlowProjection();
            updateCategoryAnalytics();
            showToast(`Sale recorded! Profit: ${formatCurrency(saleRecord.profit)}`);
            
            // Reset the form after successful submission
            resetForms();
        }

        // Initialize the app
        function init() {
            initTheme();
            document.getElementById('datePurchased').valueAsDate = new Date();
            document.getElementById('dateSold').valueAsDate = new Date();
            
            // Migration: Mark existing items as purchases
            let needsMigration = false;
            inventory.forEach(item => {
                if (item.isPurchase === undefined) {
                    item.isPurchase = true;
                    needsMigration = true;
                }
            });
            
            if (needsMigration) {
                saveData();
            }
            
            updateDropdown();
            renderTable();
            updateProfitChart();
            updateCashFlowProjection();
            updateCategoryAnalytics();
        }

        window.onload = init;
    </script>
</body>
</html>